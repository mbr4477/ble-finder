<html>
    <head>
        <title>BLE Finder</title>
    </head>
    <body>
        <button onclick="doInit()">Find</button>
        <div id="distance"></div>
        <div id="direction"></div>
        <div id="ble-location"></div>
        <div id="user-location"></div>
        <script>
            EARTH_RAD = 6378000.0; // meters
            DEG2RAD = Math.PI / 180.0;
            let lastBleLocation = { lat: 0, lon: 0 };
            let lastUserLocation = { lat: 0, lon: 0 };
            let lastUserDirection = 0;

            function distance(lat1, lon1, lat2, lon2) {
                // adapted from http://www.movable-type.co.uk/scripts/latlong.html
                let lat1rad = lat1 * DEG2RAD;
                let lon1rad = lon1 * DEG2RAD;
                let lat2rad = lat2 * DEG2RAD;
                let lon2rad = lon2 * DEG2RAD;
                let dlat = lat2rad - lat1rad;
                let dlon = lon2rad - lon1rad;
                let hav = Math.sin(dlat/2)*Math.sin(dlat/2) + 
                            Math.cos(lat1rad)*Math.cos(lat2rad)*Math.sin(dlon/2)*Math.sin(dlon/2)
                let c = 2 * Math.atan2(Math.sqrt(hav), Math.sqrt(1 - hav));
                return EARTH_RAD * c;
            }

            function getBearing(lat1, lon1, lat2, lon2) {
                // adapted from same source as distance
                let lat1rad = lat1 * DEG2RAD;
                let lon1rad = lon1 * DEG2RAD;
                let lat2rad = lat2 * DEG2RAD;
                let lon2rad = lon2 * DEG2RAD;
                let dlat = lat2rad - lat1rad;
                let dlon = lon2rad - lon1rad;
                return Math.atan2(Math.sin(dlon) * Math.cos(lat2rad), 
                        Math.cos(lat1rad) * Math.sin(lat2rad) - Math.sin(lat1rad) * Math.cos(lat2rad) * Math.cos(dlon)) / Math.PI * 180.0;
            }

            function doInit() {
                gpsInit();
                discInit();
                compassInit();
            }

            function gpsInit() {
                navigator.geolocation.watchPosition(function(pos) {
                    lastUserLocation.lat = pos.coords.latitude;
                    lastUserLocation.lon = pos.coords.longitude;
                    updateStats();
                });
            }

            function compassInit() {
                window.addEventListener('deviceorientation', function(event) {
                    lastUserDirection = event.alpha;
                    updateStats();
                });
            }

            function discInit() {
                navigator.bluetooth.requestDevice({ 
                    filters: [
                        { services: [0x1819] }
                    ]
                }).then(device => {
                    return device.gatt.connect();
                }).then(server => {
                    return server.getPrimaryService(0x1819);
                }).then(service => {
                    return service.getCharacteristics(0x2A67);
                }).then(characteristics => {
                    let locationChar = characteristics[0];
                    console.log(locationChar);
                    locationChar.addEventListener('characteristicvaluechanged', function(event) {
                        let latRaw = event.target.value.getInt32(2, true);
                        let lonRaw = event.target.value.getInt32(6, true);
                        lastBleLocation.lat = latRaw / 1e7;
                        lastBleLocation.lon = lonRaw / 1e7;
                        updateStats();
                    });
                    locationChar.startNotifications();
                });
            }

            function updateStats() {
                console.log(lastUserDirection);
                let d = distance(lastUserLocation.lat, lastUserLocation.lon, lastBleLocation.lat, lastBleLocation.lon);
                document.getElementById('distance').innerText = Math.round(d) + ' m';
                let bearing = getBearing(lastUserLocation.lat, lastUserLocation.lon, lastBleLocation.lat, lastBleLocation.lon);
                bearing = Math.round(bearing + 360) % 360;
                document.getElementById('direction').innerText = bearing - lastUserDirection;
                document.getElementById('user-location').innerText = lastUserLocation.lat + "," + lastUserLocation.lon;
                document.getElementById('ble-location').innerText = lastBleLocation.lat + "," + lastBleLocation.lon;
            }

        </script>
    </body>
</html>